name: deployment infra pipeline
on: 
    push:
        branches: [main , dev]
    pull_request:
    workflow_dispatch:    
jobs:
    Setup:
        runs-on: ubuntu-latest
        steps:
            - name: checkout repository
              uses: actions/checkout@v4
            - name: terraform setup
              uses: hashicorp/setup-terraform@v3
              with: 
                terraform_version: "1.1.7"
            - name: Terrafom initialization
              run: terraform init
            - name: azure login
              uses : azure/login@v2
              with:
                client-id: ${{ secrets.AZURE_CLIENT_ID }}
                tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            - name: Terraform init
              run: terraform init
            - name: Terraform Validation
              run: terraform validate
            - name: Terraform Plan
              run: terraform plan -out=tfplan
            - name: Terraform Apply
              if: github.ref == 'refs/heads/main'
              run: terraform apply -auto-approve tfplan